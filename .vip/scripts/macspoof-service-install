#!/usr/bin/env bash

set -e

# ===== CHANGE THIS =====
INTERFACE="$(wlanDevice)"
SERVICE="/etc/systemd/system/macspoof.service"
NMCONF="/etc/NetworkManager/conf.d/99-macspoof.conf"
# =======================

echo "[+] Installing macchanger..."
sudo pacman -S --noconfirm macchanger

# -----------------------------
# Disable NetworkManager MAC tampering
# -----------------------------
echo "[+] Creating NetworkManager config..."

sudo mkdir -p /etc/NetworkManager/conf.d

sudo tee "$NMCONF" > /dev/null <<EOF
[device]
wifi.scan-rand-mac-address=no

[connection]
wifi.cloned-mac-address=preserve
ethernet.cloned-mac-address=preserve
EOF

# -----------------------------
# Create EARLY boot service
# -----------------------------
echo "[+] Creating early-boot macspoof service..."

sudo tee "$SERVICE" > /dev/null <<EOF
[Unit]
Description=Spoof MAC before NetworkManager
DefaultDependencies=no
Before=NetworkManager.service network-pre.target
Wants=network-pre.target
After=sysinit.target

[Service]
Type=oneshot
ExecStart=/usr/bin/ip link set dev $INTERFACE down
ExecStart=/usr/bin/macchanger -r $INTERFACE
ExecStart=/usr/bin/ip link set dev $INTERFACE up
RemainAfterExit=yes

[Install]
WantedBy=sysinit.target
EOF

# -----------------------------
# Enable
# -----------------------------
echo "[+] Reloading systemd..."
sudo systemctl daemon-reload

echo "[+] Enabling macspoof..."
sudo systemctl enable macspoof.service

echo "[+] Restarting NetworkManager to apply config..."
sudo systemctl restart NetworkManager

echo
echo "Done!"
echo
echo "Boot order now:"
echo "  macspoof → NetworkManager → connect"
echo
echo "Verify with:"
echo "  ip link show $INTERFACE"

